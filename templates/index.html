{% extends "base.html" %}
{% block content %}

		<header class="am-topbar am-topbar-fixed-top">
			<div class="am-topbar-left am-hide-sm-only">
                <img src="../static/img/title.png" alt="BillAnalysis Logo" style="height:60px;">
            </div>

			<div class="contain">
				<ul class="am-nav am-navbar-nav am-navbar-left">
					<li><h4 class="page-title">支出预览</h4></li>
				</ul>
			</div>
		</header>



		<div class="content-page">
			<!-- Start content -->
			<div class="content">
				<div class="am-g">
					<!-- Row start -->
						<div class="am-u-md-3">
							<div class="card-box">
								<h4 class="header-title m-t-0 m-b-30">总支出</h4>
								<div class="widget-chart-1 am-cf">
                                    <div id="widget-chart-box-1" style="height: 110px;width: 110px;float: left;">
                                    </div>

                                    <div class="widget-detail-1" style="float: right;">
                                        <h2 class="p-t-10 m-b-0"> {{ total_expend }} </h2>
                                        <p class="text-muted">总支出金额</p>
                                    </div>
                                </div>
							</div>
						</div>
						<!-- col end -->
						<div class="am-u-md-3">
							<div class="card-box">
								<h4 class="header-title m-t-0 m-b-30">单笔最高支出</h4>
								<div class="widget-box-2">
                                    <div class="widget-detail-2">
                                        <span class="badge  pull-left m-t-20  am-round" style="color: #fff; background: #0e90d2;">{{ zcyl_dbzgzcbfb }} <i class="zmdi zmdi-trending-up"></i> </span>
                                        <h2 class="m-b-0"> {{ m_expend }} </h2>

                                    </div>
                                    <div class="am-progress am-progress-xs am-margin-bottom-0">
                                        <!-- {{ expend_percent }} -->
									    <div class="am-progress-bar" style="width: {{ expend_percent }}%"></div>
									</div>
                                </div>
							</div>
						</div>
						<!-- col end -->
						<div class="am-u-md-3">
							<div class="card-box">
								<h4 class="header-title m-t-0 m-b-30">总收入</h4>
								<div class="widget-chart-1 am-cf">
                                    <div id="widget-chart-box-2" style="height: 110px;width: 110px;float: left;">
                                    </div>

                                    <div class="widget-detail-1" style="float: right;">
                                        <h2 class="p-t-10 m-b-0"> {{ total_income }} </h2>
                                        <p class="text-muted">总收入金额</p>
                                    </div>
                                </div>
							</div>
						</div>
						<!-- col end -->
						<div class="am-u-md-3">
							<div class="card-box">
								<h4 class="header-title m-t-0 m-b-30">单笔最高收入</h4>
								<div class="widget-box-2">
                                    <div class="widget-detail-2">
                                        <span class="badge  pull-left m-t-20  am-round progress-bar-pink" style="color: #fff;">{{ zcyl_dbzgsrbfb }} <i class="zmdi zmdi-trending-up"></i> </span>
                                        <h2 class="m-b-0"> {{ m_income }} </h2>

                                    </div>
                                    <div class="am-progress am-progress-xs am-margin-bottom-0" style="background: rgba(255, 138, 204, 0.2);">
									    <div class="am-progress-bar progress-bar-pink" style="width: {{ income_percent }}%"></div>
									</div>
                                </div>
							</div>
						</div>
					<!-- Row end -->
				</div>
				
				<div class="am-g">
					<!-- Row start -->
					<div class="am-u-md-4">
						<div class="card-box">
							<h4 class="header-title m-t-0">消费分类</h4>

                            <!-- 消费分类饼图 input: pie_data [{'value':v,'name':k},...] -->
							<div id="index-pie-1" style="height: 345px;height: 300px;"></div>
  
                            <div id="pie_data" data-json='{{ pie_data|tojson }}'></div>
                            <script>
                                var myChart = echarts.init(document.getElementById("index-pie-1"));
                                var pie_data = JSON.parse(document.getElementById("pie_data").dataset.json);

                                
                                pie_data.sort(function(a, b) { return b.value - a.value; });
                                var top10 = pie_data.slice(0, 10);
                                
                                var option = {
                                    tooltip : {
                                        trigger: 'item',
                                        // 显示两位小数
                                        formatter: function(params) {
                                            return params.seriesName + '<br/>' +
                                                params.name + ' : ' + params.value + ' (' + 
                                                (params.percent ? params.percent.toFixed(2) : '0.00') + '%)';
                                        },
                                        confine: true // 自适应位置，防止溢出
                                    },
                                    // 图例只显示前10个占比最高的分类
                                    legend: {
                                        orient : 'vertical',
                                        left : 'left',
                                        data: top10.map(function(item){ return item.name; })
                                    },
                                    toolbox: {
                                        show : true,
                                        feature : {
                                            mark : {show: true},
                                            dataView : {show: true, readOnly: false},
                                            magicType : {
                                                show: true, 
                                                type: ['pie', 'funnel'],
                                                option: {
                                                    funnel: {
                                                        x: '25%',
                                                        width: '50%',
                                                        funnelAlign: 'center',
                                                        max: 1548
                                                    }
                                                }
                                            },
                                            restore : {show: true},
                                            saveAsImage : {show: true}
                                        }
                                    },
                                    calculable : true,
                                    series : [
                                        {
                                            name:'类别',
                                            type:'pie',
                                            radius : ['50%', '70%'],
                                            itemStyle : {
                                                normal : {
                                                    label : {
                                                        show : false
                                                    },
                                                    labelLine : {
                                                        show : false
                                                    }
                                                },
                                                emphasis : {
                                                    label : {
                                                        show : true,
                                                        position : 'center',
                                                        textStyle : {
                                                            fontSize : '20',
                                                            fontWeight : 'bold'
                                                        }
                                                    }
                                                }
                                            },
                                            data: pie_data.map(function(item) {
                                                return {
                                                    value: item.value,
                                                    name: item.name
                                                };
                                            })
                                        }
                                    ]
                                };
                            myChart.setOption(option);
                            </script>
						</div>
					</div>
					
                    <div class="am-u-md-4">
                        <div class="card-box">
                            <h4 class="header-title m-t-0">近一周消费</h4>
                            <!-- 近一周消费柱状图 -->
                            <div id="index-bar-1" style="height: 345px;"></div>

                            <!-- 用于存储 bar_data -->
                            <div id="bar_data" data-json='{{ bar_data|tojson }}' style="display: none;"></div>

                            <script>
                                var barData = JSON.parse(document.getElementById("bar_data").getAttribute("data-json"));
                                var xData = barData.date;    // x 轴为日期
                                var yData = barData.counts;  // y 轴为消费总金额

                                // 初始化图表
                                var myChart = echarts.init(document.getElementById("index-bar-1"));
                                var option = {
                                color: ['#3398DB'],
                                tooltip: {
                                    trigger: 'axis',
                                    axisPointer: {
                                    type: 'shadow'
                                    }
                                },
                                grid: {
                                    bottom: 20,
                                    left: 30,
                                    containLabel: true
                                },
                                xAxis: [
                                    {
                                    type: 'category',
                                    name: '日期',
                                    nameLocation: 'middle',
                                    nameGap: 20,
                                    data: xData,
                                    axisTick: {
                                        alignWithLabel: true
                                    },
                                    axisLabel: {
                                        interval: 0,      // 关键：强制全部显示
                                        fontSize: 12      // 可选：字体大小调整
                                    }
                                    }
                                ],
                                yAxis: [
                                    {
                                    type: 'value',
                                    name: '消费总金额',
                                    nameLocation: 'end',
                                    nameGap: 30,
                                    nameTextStyle: {
                                    fontSize: 12,
                                    color: '#666'
                                    }
                                    }
                                ],
                                series: [
                                    {
                                    name: '消费总金额',
                                    type: 'bar',
                                    barWidth: '60%',
                                    data: yData
                                    }
                                ]
                                };

                                // 使用刚指定的配置项和数据显示图表
                                myChart.setOption(option);
                            </script>
                        </div>
                    </div>
					
                    <div class="am-u-md-4">
                        <div class="card-box">
                            <h4 class="header-title m-t-0">两周高低消费对比</h4>
                            <!-- 两周高低消费对比折线图 -->
                            <div id="index-line-1" style="height: 345px;height: 300px;"></div>

                            <!-- 在这里放 hidden div 用于传递 JSON 数据 -->
                            <div id="highest_lowest_expend" data-json='{{ highest_lowest_expend|tojson }}'></div>

                            <script>
                                // 读取数据
                                var expendData = JSON.parse(document.getElementById("highest_lowest_expend").getAttribute("data-json"));

                                // 最高一周和最低一周每天的消费金额
                                var highestData = [];
                                var lowestData = [];

                                if (expendData.highest && expendData.highest.days) {
                                    highestData = [
                                        expendData.highest.days['周一'] || 0,
                                        expendData.highest.days['周二'] || 0,
                                        expendData.highest.days['周三'] || 0,
                                        expendData.highest.days['周四'] || 0,
                                        expendData.highest.days['周五'] || 0,
                                        expendData.highest.days['周六'] || 0,
                                        expendData.highest.days['周日'] || 0
                                    ];
                                }

                                if (expendData.lowest && expendData.lowest.days) {
                                    lowestData = [
                                        expendData.lowest.days['周一'] || 0,
                                        expendData.lowest.days['周二'] || 0,
                                        expendData.lowest.days['周三'] || 0,
                                        expendData.lowest.days['周四'] || 0,
                                        expendData.lowest.days['周五'] || 0,
                                        expendData.lowest.days['周六'] || 0,
                                        expendData.lowest.days['周日'] || 0
                                    ];
                                }

                                // 初始化图表
                                var myChart = echarts.init(document.getElementById("index-line-1"));

                                var option = {
                                    tooltip: {
                                        trigger: 'axis'
                                    },
                                    legend: {
                                        data: ['消费最高一周', '消费最低一周'],
                                        right: 10  // 放到右上角
                                    },
                                    xAxis: {
                                        type: 'category',
                                        boundaryGap: false,
                                        data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
                                    },
                                    yAxis: {
                                        type: 'value',
                                        axisLabel: {
                                            formatter: '{value} ￥'
                                        }
                                    },
                                    series: [
                                        {
                                            name: '消费最高一周',
                                            type: 'line',
                                            data: highestData,
                                            markPoint: {
                                                data: [
                                                    {type: 'max', name: '最大值'},
                                                    {type: 'min', name: '最小值'}
                                                ]
                                            },
                                            markLine: {
                                                data: [
                                                    {type: 'average', name: '平均值'}
                                                ]
                                            }
                                        },
                                        {
                                            name: '消费最低一周',
                                            type: 'line',
                                            data: lowestData,
                                            markPoint: {
                                                data: [
                                                    {type: 'max', name: '最大值'},
                                                    {type: 'min', name: '最小值'}
                                                ]
                                            },
                                            markLine: {
                                                data: [
                                                    {type: 'average', name: '平均值'}
                                                ]
                                            }
                                        }
                                    ]
                                };

                                myChart.setOption(option);
                            </script>
                        </div>
                    </div>

					<!-- Row end -->
				</div>
				
				<div class="am-g">

					</div>
					
					
					<!-- Row start -->
					<div class="am-g">
						<!-- col start -->
						<div class="am-u-md-4">
							<div class="card-box">
								<h4 class="header-title m-t-0 m-b-30">消费活跃区域</h4>
                                <!-- 消费活跃区域视图 -->
								<div class="inbox-widget nicescroll" style="height: 315px; overflow: hidden; outline: none;" tabindex="5000">


                                    <!--<a href="#">
                                        <div class="inbox-item">
                                            <div class="inbox-item-img"><img src="../static/img/city.png" class="img-circle" alt=""></div>
                                            <p class="inbox-item-author">北京</p>
                                            <p class="inbox-item-text">WECOME TO CITY</p>
                                            <p class="inbox-item-date">13:40 PM</p>
                                        </div>
                                    </a>-->


                                    {% for i in xfcity %}

                                        <a href="#">
                                            <div class="inbox-item">
                                                <div class="inbox-item-img"><img src="../static/img/city.png" class="img-circle" alt=""></div>
                                                <p class="inbox-item-author">{{ i }}</p>
                                                <p class="inbox-item-text">WELCOME TO THIS CITY</p>
                                                <p class="inbox-item-date">12:00 PM</p>
                                            </div>
                                         </a>

                                    {% endfor %}

                                </div>
							</div>
						</div>
						<!-- col end -->
						

                        <!-- 消费清单部分 -->
						<!-- col start -->
						<div class="am-u-md-8">
                            <div class="card-box">
                                <h4 class="header-title m-t-0 m-b-30">TOP10 消费清单</h4>
                                <div class="am-scrollable-horizontal am-text-ms" style="font-family: '微软雅黑';">
                                    <table class="am-table am-text-nowrap">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>商品名称</th>
                                            <th>商品金额</th>
                                            <th>交易时间</th>
                                            <th>交易状态</th>
                                            <th>支付方式</th>
                                        </tr>
                                        </thead>
                                        <tbody>

                                        {% for item in top10_expend %}
                                            <tr>
                                                <td>{{ item.序号 }}</td>
                                                <td>
                                                    <div style="
                                                        max-width: 200px;       /* 设置最大宽度 */
                                                        overflow: hidden;       /* 超出隐藏 */
                                                        white-space: nowrap;    /* 不换行 */
                                                        text-overflow: ellipsis;/* 超出部分显示省略号 */
                                                    ">
                                                        {{ item.商品名称 }}
                                                    </div>
                                                </td>
                                                <td>{{ item.交易金额 }}</td>
                                                <td>{{ item.交易时间 }}</td>
                                                <td>
                                                    <span class="label 
                                                    {% if item.交易状态 == '交易成功' %}
                                                        label-success
                                                    {% elif item.交易状态 == '交易关闭' %}
                                                        label-danger
                                                    {% else %}
                                                        label-default
                                                    {% endif %}
                                                    ">{{ item.交易状态 }}</span>
                                                </td>
                                                <td>{{ item.支付方式 }}</td>
                                            </tr>
                                        {% endfor %}

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

						<!-- col end -->
					</div>

			</div>
		</div>


{% endblock %}